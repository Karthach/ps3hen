<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Instalador PS3 HEN — Automático</title>
<style>
  body{background:#071018;color:#e6eef6;font-family:Helvetica,Arial,system-ui;margin:0;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  h1{font-size:20px;margin:0 0 8px}
  p.lead{color:#9aa6b2;margin:0 0 14px}
  .hero{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .primary{display:block;width:100%;padding:16px;border-radius:12px;background:#6dd3ff;color:#021224;text-decoration:none;text-align:center;font-weight:700;font-size:18px;margin-top:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  select,input[type=checkbox]{padding:8px;border-radius:8px;border:0;background:#0b2130;color:#e6eef6}
  .small{padding:8px 10px;border-radius:8px;background:#0f2b3a;color:#aee;border:0}
  .meta{color:#9aa6b2;margin-top:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px}
  .card{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
  .ver{font-weight:700}
  .checksum{font-size:12px;color:#9aa6b2;word-break:break-all}
  .hint{font-size:13px;color:#bcd}
  .flex{display:flex;gap:8px;align-items:center}
  footer{color:#8fa3b2;margin-top:12px;font-size:13px}
  pre{background:#021018;padding:8px;border-radius:8px;color:#9fe}
  @media (max-width:480px){h1{font-size:18px}.primary{font-size:16px;padding:14px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>Instalador PS3 HEN — Flujo automático</h1>
    <p class="lead">Detección, verificación SHA256 y descarga automática del HEN recomendado. Recomendado: usar desde la PS3 y asegurarse de conexión estable.</p>

    <div class="controls">
      <label class="flex">Versión detectada: <strong id="detected" style="margin-left:8px">—</strong></label>
      <select id="fwOverride" title="Selecciona firmware (anular detección)"></select>
      <label style="display:flex;align-items:center;gap:6px"><input id="dexToggle" type="checkbox"> Usar DEX si disponible</label>
      <button id="refreshBtn" class="small">Detectar</button>
    </div>

    <a id="primaryBtn" class="primary" href="#">Cargando HEN...</a>

    <div class="controls" style="margin-top:8px">
      <button id="verifyBtn" class="small">Verificar manual</button>
      <button id="copyBtn" class="small">Copiar enlace</button>
      <a id="releaseBtn" class="small" href="#" target="_blank">Ir a Release</a>
      <a id="emergencyBtn" class="small" href="/hen/index.html" target="_blank">Instalador de emergencia</a>
    </div>

    <div class="meta" id="status">Inicializando…</div>
    <pre id="log" style="display:none"></pre>
  </div>

  <section style="margin-top:14px">
    <h2 style="margin:6px 0">HEN disponibles</h2>
    <div id="versions" class="grid"></div>
  </section>

  <section style="margin-top:14px">
    <h2 style="margin:6px 0">Instrucciones</h2>
    <ol style="color:#9aa6b2">
      <li>Accede desde la PS3. La web detectará tu firmware y seleccionará el HEN más adecuado.</li>
      <li>La página verificará automáticamente el SHA256; si coincide se descargará el archivo para instalarlo desde USB o navegador.</li>
      <li>Si la verificación falla se mostrará un aviso y no se descargará el binario.</li>
    </ol>
    <div class="meta">Hora actual: <span id="now"></span></div>
  </section>

  <footer>
    Si algo falla: limpia caché del navegador, añade la página a favoritos y prueba de nuevo. Usa Issues para reportar problemas.
  </footer>
</div>

<script>
function ajaxGetRaw(url, responseType, cb){
  try{var xhr=new XMLHttpRequest();xhr.open('GET',url,true);xhr.responseType=responseType;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200)cb(null,xhr);else cb(new Error('HTTP '+xhr.status))}};xhr.send(null);}catch(e){cb(e)}
}
function detectFW(){var ua=navigator.userAgent||'';var fw=null;try{if(ua.indexOf('PLAYSTATION')!==-1){var i=ua.indexOf('5.0 (');var j=ua.indexOf(') Apple');if(i!==-1&&j>i)fw=ua.substring(i+19,j)}}catch(e){fw=null}return fw}
function numeric(v){var m=(v||'').match(/\d+(?:\.\d+)?/);return m?parseFloat(m[0]):0}
function verFromPath(p){var m=p.match(/hen\/([0-9.]+D?)\//);return m?m[1]:'general'}
function toHex(buffer){var hex='';var a=new Uint8Array(buffer);for(var i=0;i<a.length;i++){hex += ('00'+a[i].toString(16)).slice(-2);}return hex}

// UI
var detectedEl=document.getElementById('detected');var fwSelect=document.getElementById('fwOverride');var dexToggle=document.getElementById('dexToggle');var refreshBtn=document.getElementById('refreshBtn');var primaryBtn=document.getElementById('primaryBtn');var versionsEl=document.getElementById('versions');var statusEl=document.getElementById('status');var verifyBtn=document.getElementById('verifyBtn');var copyBtn=document.getElementById('copyBtn');var releaseBtn=document.getElementById('releaseBtn');var logEl=document.getElementById('log');var nowEl=document.getElementById('now');

nowEl.textContent = new Date().toISOString();
var detectedFW = detectFW(); if(detectedFW) detectedEl.textContent = detectedFW; else detectedEl.textContent = 'No PS3 detectada';

// load releases
ajaxGetRaw('/RELEASES.json','text', function(err,xhr){ if(err){statusEl.textContent='No se pudo leer RELEASES.json — uso lista estática'; initializeStatic(); return;} try{var data=JSON.parse(xhr.responseText);var files=data.files||[];var map={};var list=[];files.forEach(function(f){if(/PS3HEN\.p3t$/.test(f.path)){list.push({ver:verFromPath('/'+f.path),path:'/'+f.path,sha:f.sha256||f.sha||''})};map['/'+f.path]=f.sha256||f.sha});list.sort(function(a,b){return numeric(b.ver)-numeric(a.ver)});populateFW(list);renderList(list,map);autoSelect(list,map);}catch(e){statusEl.textContent='Error parseando RELEASES.json';initializeStatic()}})

function populateFW(list){fwSelect.innerHTML='';var opt=document.createElement('option');opt.value='';opt.textContent='(Usar detección automática)';fwSelect.appendChild(opt);var seen={};list.forEach(function(it){var n=it.ver.replace('D','');if(!seen[n]){seen[n]=true;var o=document.createElement('option');o.value=n;o.textContent=n;fwSelect.appendChild(o)}})}
function renderList(list,map){versionsEl.innerHTML='';list.forEach(function(it){var c=document.createElement('div');c.className='card';var v=document.createElement('div');v.className='ver';v.textContent='Versión '+it.ver;var chk=document.createElement('div');chk.className='checksum';chk.textContent='SHA256: '+(map[it.path]||it.sha||'—');var dl=document.createElement('a');dl.className='primary';dl.href=it.path;dl.target='_blank';dl.textContent='Descargar '+it.ver;dl.style.marginTop='8px';c.appendChild(v);c.appendChild(chk);c.appendChild(dl);versionsEl.appendChild(c)})}

function autoSelect(list,map){var prefer=fwSelect.value||detectedFW;var dex=dexToggle.checked;var candidates=list.slice();if(prefer){candidates=candidates.filter(function(x){if(dex){return x.ver===prefer||x.ver===prefer+'D'}return x.ver===prefer})}if(candidates.length===0)candidates=list.slice();candidates.sort(function(a,b){return numeric(b.ver)-numeric(a.ver)});var best=candidates[0];if(best){primaryBtn.href=best.path;primaryBtn.textContent='Instalar HEN '+best.ver+' — Verificando...';primaryBtn.dataset.sha=best.sha||map[best.path]||'';statusEl.textContent='Seleccionado: '+best.ver; // start automatic verify+download
  setTimeout(function(){verifyAndDownload(best,map[best.path||best.path.substring(1)])},600);
}else{primaryBtn.textContent='No hay HEN disponible';statusEl.textContent='No se encontró HEN'}}

function verifyAndDownload(item, expectedSha){
  logEl.style.display='block'; logEl.textContent='Iniciando verificación automática...\n';
  if(!expectedSha){statusEl.textContent='Sin checksum disponible: abortando descarga automática'; logEl.textContent += 'No hay SHA en RELEASES.json\n'; return}
  // fetch file as arraybuffer
  statusEl.textContent='Descargando archivo para verificar (esto puede tardar)...';
  ajaxGetRaw(item.path,'arraybuffer', function(err,xhr){
    if(err){statusEl.textContent='Error al descargar archivo para verificar: '+err.message; logEl.textContent += 'Error descarga: '+err.message+'\n'; return}
    var ab = xhr.response;
    if(window.crypto && crypto.subtle){
      statusEl.textContent='Calculando SHA256...';
      crypto.subtle.digest('SHA-256', ab).then(function(hash){
        var hex = toHex(hash);
        logEl.textContent += 'SHA calculado: '+hex+'\nSHA esperado: '+expectedSha+'\n';
        if(hex === expectedSha){
          statusEl.textContent='SHA verificado: OK — iniciando descarga';
          // trigger download
          var blob = new Blob([ab], {type: 'application/octet-stream'});
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a'); a.href = url; a.download = item.path.split('/').pop(); document.body.appendChild(a); a.click(); a.remove();
          logEl.textContent += 'Descarga iniciada.';
        } else {
          statusEl.textContent='SHA NO coincide — cancelado';
          logEl.textContent += 'SHA mismatch — descarga cancelada.';
        }
      }).catch(function(e){statusEl.textContent='Error calculando SHA: '+e.message; logEl.textContent += 'Error SHA: '+e.message+'\n';});
    } else {
      statusEl.textContent='Web Crypto no disponible en este navegador — no se puede verificar automáticamente';
      logEl.textContent += 'Web Crypto API no disponible. Se requiere verificación manual.';
    }
  });
}

// events
refreshBtn.addEventListener('click', function(){detectedFW=detectFW();detectedEl.textContent=detectedFW||'Manual';ajaxGetRaw('/RELEASES.json','text', function(err,xhr){if(!err){var data=JSON.parse(xhr.responseText);var files=data.files||[];var list=[];files.forEach(function(f){if(/PS3HEN\.p3t$/.test(f.path))list.push({ver:verFromPath('/'+f.path),path:'/'+f.path,sha:f.sha256||f.sha||''})});list.sort(function(a,b){return numeric(b.ver)-numeric(a.ver)});autoSelect(list) }})});
fwSelect.addEventListener('change', function(){ajaxGetRaw('/RELEASES.json','text', function(err,xhr){if(!err){var data=JSON.parse(xhr.responseText);var files=data.files||[];var list=[];files.forEach(function(f){if(/PS3HEN\.p3t$/.test(f.path))list.push({ver:verFromPath('/'+f.path),path:'/'+f.path,sha:f.sha256||f.sha||''})});list.sort(function(a,b){return numeric(b.ver)-numeric(a.ver)});autoSelect(list)}})});
verifyBtn.addEventListener('click', function(){var path=primaryBtn.getAttribute('href');var sha=primaryBtn.dataset.sha||''; if(!path||path==='#'){alert('No hay archivo seleccionado');return} verifyAndDownload({path:path}, sha)});
copyBtn.addEventListener('click', function(){var url=location.origin+primaryBtn.getAttribute('href');try{navigator.clipboard.writeText(url).then(function(){alert('Enlace copiado')}, function(){prompt('Copiar enlace manualmente:', url)})}catch(e){prompt('Copiar enlace manualmente:', url)}});

function initializeStatic(){var staticList=[{ver:'4.91',path:'/hen/4.91/PS3HEN.p3t'},{ver:'4.90',path:'/hen/4.90/PS3HEN.p3t'},{ver:'4.89',path:'/hen/4.89/PS3HEN.p3t'},{ver:'4.88',path:'/hen/4.88/PS3HEN.p3t'}];populateFW(staticList);renderList(staticList,{});autoSelect(staticList)}

function renderList(list,map){versionsEl.innerHTML='';list.forEach(function(it){var c=document.createElement('div');c.className='card';var v=document.createElement('div');v.className='ver';v.textContent='Versión '+it.ver;var chk=document.createElement('div');chk.className='checksum';chk.textContent='SHA256: '+(map[it.path]||it.sha||'—');var dl=document.createElement('a');dl.className='primary';dl.href=it.path;dl.target='_blank';dl.textContent='Descargar '+it.ver;dl.style.marginTop='8px';c.appendChild(v);c.appendChild(chk);c.appendChild(dl);versionsEl.appendChild(c)})}

</script>
</body>
</html>
