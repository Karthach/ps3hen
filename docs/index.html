<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Instalador PS3 HEN — Acceso rápido</title>
<style>
  body{background:#071018;color:#e6eef6;font-family:Helvetica,Arial,system-ui;margin:0;padding:18px}
  .wrap{max-width:920px;margin:0 auto}
  h1{font-size:20px;margin:0 0 8px}
  p.lead{color:#9aa6b2;margin:0 0 14px}
  .hero{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  .primary{display:block;width:100%;padding:16px;border-radius:12px;background:#6dd3ff;color:#021224;text-decoration:none;text-align:center;font-weight:700;font-size:18px;margin-top:12px}
  .secondary{display:inline-block;padding:10px 12px;border-radius:10px;background:#0f2b3a;color:#aee;text-decoration:none;margin-right:8px}
  .meta{color:#9aa6b2;margin-top:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:12px}
  .card{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px}
  .ver{font-weight:700}
  .checksum{font-size:12px;color:#9aa6b2;word-break:break-all}
  .hint{font-size:13px;color:#bcd}
  button{padding:10px 12px;border-radius:10px;border:0}
  @media (max-width:480px){h1{font-size:18px}.primary{font-size:16px;padding:14px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <h1>Instalador PS3 HEN — Acceso rápido</h1>
    <p class="lead">Accede desde la PS3, detecta tu firmware y pulsa un solo botón para descargar el HEN adecuado. Comprueba el SHA256 antes de instalar.</p>

    <div>
      <div class="meta">Versión detectada: <strong id="detected">—</strong></div>
      <a id="primaryBtn" class="primary" href="#">Cargando HEN...</a>
      <div style="margin-top:8px">
        <a id="webInstaller" class="secondary" href="/hen/index.html" target="_blank">Abrir instalador web (hen/index.html)</a>
        <a id="listAll" class="secondary" href="/docs/" target="_blank">Ver todos</a>
      </div>
      <div class="meta hint" id="status">Buscando versiones disponibles…</div>
    </div>
  </div>

  <section style="margin-top:14px">
    <h2 style="margin:6px 0">HEN disponibles</h2>
    <div id="versions" class="grid"></div>
  </section>

  <section style="margin-top:14px">
    <h2 style="margin:6px 0">Instrucciones rápidas</h2>
    <ol style="color:#9aa6b2">
      <li>Desde la PS3 abre esta página y usa "Detectar" (se detecta automáticamente) o mira la versión mostrada.</li>
      <li>Pulsa el botón principal para descargar el archivo .p3t correspondiente.</li>
      <li>Antes de ejecutar, comprueba que el SHA256 mostrado coincide con el de RELEASES.json o el asset .sha256 del Release.</li>
    </ol>
    <div class="meta">Fecha: 2026-01-21T18:45:31Z</div>
  </section>
</div>

<script>
// Compatibilidad básica con navegadores antiguos (PS3)
function ajaxGet(url, cb){
  try{
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function(){ if(xhr.readyState===4){ if(xhr.status===200) cb(null, xhr.responseText); else cb(new Error('HTTP '+xhr.status)); }};
    xhr.send(null);
  }catch(e){cb(e);}
}

function detectFW(){
  var ua = navigator.userAgent || '';
  var fw = null;
  try{
    if(ua.indexOf('PLAYSTATION')!==-1){
      var i = ua.indexOf('5.0 (');
      var j = ua.indexOf(') Apple');
      if(i!==-1 && j>i) fw = ua.substring(i+19,j);
    }
  }catch(e){fw=null;}
  return fw;
}

function verKeyFromPath(p){
  var m = p.match(/hen\/([0-9.]+D?)\//);
  if(m) return m[1];
  return 'general';
}

function numeric(v){
  // convert '4.82D'->4.82, drop non-digit suffix
  var m = (v||'').match(/\d+(?:\.\d+)?/);
  return m?parseFloat(m[0]):0;
}

function chooseBest(available, fw){
  if(!fw) return available.length?available[0]:null;
  // exact match
  for(var i=0;i<available.length;i++){ if(available[i].ver===fw) return available[i]; }
  // match by numeric <= fw, choose highest <= fw
  var target = numeric(fw), best=null;
  for(i=0;i<available.length;i++){ var n = numeric(available[i].ver); if(n<=target){ if(!best || numeric(best.ver)<n) best=available[i]; }}
  if(best) return best;
  // fallback newest (highest numeric)
  var newest=available[0]; for(i=1;i<available.length;i++){ if(numeric(available[i].ver)>numeric(newest.ver)) newest=available[i]; }
  return newest;
}

function renderVersions(list, releaseMap){
  var container = document.getElementById('versions'); container.innerHTML='';
  for(var i=0;i<list.length;i++){
    var it = list[i];
    var card = document.createElement('div'); card.className='card';
    var v = document.createElement('div'); v.className='ver'; v.textContent = 'Versión ' + it.ver;
    var btn = document.createElement('a'); btn.className='primary'; btn.href = it.path; btn.textContent = 'Descargar HEN (' + it.ver + ')'; btn.target='_blank';
    btn.style.padding='10px'; btn.style.fontSize='14px'; btn.style.display='block'; btn.style.marginTop='8px';
    var chk = document.createElement('div'); chk.className='checksum'; chk.textContent = 'SHA256: ' + (releaseMap[it.path] || '—');
    card.appendChild(v); card.appendChild(chk); card.appendChild(btn);
    container.appendChild(card);
  }
}

// Main
var detected = detectFW();
if(detected) document.getElementById('detected').textContent = detected; else document.getElementById('detected').textContent = 'No PS3 detectada';

// Load RELEASES.json to find files and checksums
ajaxGet('/RELEASES.json', function(err, txt){
  var statusEl = document.getElementById('status');
  if(err){ statusEl.textContent = 'No se pudo leer RELEASES.json: mostrando lista estática.'; buildStatic(); return; }
  try{
    var data = JSON.parse(txt);
    var files = data.files || [];
    var map = {};
    var versions = {};
    for(var i=0;i<files.length;i++){
      var p = files[i].path;
      var sha = files[i].sha256 || files[i].sha || '';
      map[p] = sha;
      if(/PS3HEN\.p3t$/.test(p)){
        var ver = verKeyFromPath(p);
        if(!versions[ver]) versions[ver]=[];
        versions[ver].push({ver:ver,path:'/'+p});
      }
    }
    // flatten
    var list = [];
    for(var k in versions){
      // pick first for each ver
      list.push(versions[k][0]);
    }
    // sort by numeric desc
    list.sort(function(a,b){return numeric(b.ver)-numeric(a.ver);});

    // choose best
    var best = chooseBest(list, detected);
    if(best){
      var primary = document.getElementById('primaryBtn');
      primary.href = best.path;
      primary.textContent = 'Instalar HEN para ' + best.ver + ' — Descargar';
      document.getElementById('status').textContent = 'Se ha seleccionado automáticamente la versión más adecuada: ' + best.ver;
      // show checksum near button
      var cs = map[best.path] || map[best.path.substring(1)];
      if(cs){
        var s = document.createElement('div'); s.className='meta checksum'; s.textContent = 'SHA256: ' + cs; s.style.marginTop='6px';
        primary.parentNode.insertBefore(s, primary.nextSibling);
      }
    }
    renderVersions(list, map);
  }catch(e){ statusEl.textContent = 'ERROR al parsear RELEASES.json'; buildStatic(); }
});

function buildStatic(){
  // fallback static list from files present
  var staticList = [
    {ver:'4.91', path:'/hen/4.91/PS3HEN.p3t'},
    {ver:'4.90', path:'/hen/4.90/PS3HEN.p3t'},
    {ver:'4.89', path:'/hen/4.89/PS3HEN.p3t'},
    {ver:'4.88', path:'/hen/4.88/PS3HEN.p3t'}
  ];
  renderVersions(staticList, {});
  document.getElementById('status').textContent = 'Lista estática cargada.';
}

</script>
</body>
</html>
