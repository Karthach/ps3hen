<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Instalador PS3 HEN — Centro (Reparado)</title>
<style>body{background:#071018;color:#e6eef6;font-family:Helvetica,Arial;margin:0;padding:18px}.wrap{max-width:1100px;margin:0 auto}.card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}.meta{color:#9aa6b2}</style>
</head>
<body>
<div class="wrap">
  <h1>Instalador PS3 HEN</h1>
  <div id="status" class="meta">Estado: inicializando...</div>
  <div class="card" style="margin-top:12px">
    <label>Selecciona versión:</label>
    <select id="verSelect"></select>
    <div style="margin-top:8px">
      <a id="downloadBtn" href="#">Descargar</a>
      <button id="verifyBtn">Verificar SHA256</button>
      <button id="copyBtn">Copiar enlace</button>
    </div>
    <div id="fileSha" class="meta">SHA256: —</div>
  </div>
  <div class="card" style="margin-top:12px">
    <h3>Detalles</h3>
    <div id="detector" class="meta">Detectando...</div>
  </div>
</div>

<script>
function ajax(url, cb, responseType){try{var x=new XMLHttpRequest();x.open('GET',url,true);if(responseType)x.responseType=responseType;x.onreadystatechange=function(){if(x.readyState===4){if(x.status===200)cb(null,x);else cb(new Error('HTTP '+x.status))}};x.send(null);}catch(e){cb(e)}}
var statusEl=document.getElementById('status');var sel=document.getElementById('verSelect');var fileSha=document.getElementById('fileSha');var downloadBtn=document.getElementById('downloadBtn');var verifyBtn=document.getElementById('verifyBtn');var copyBtn=document.getElementById('copyBtn');

function loadReleases(cb){statusEl.textContent='Estado: cargando /RELEASES.json'; ajax('/RELEASES.json', function(err,x){ if(!err){ try{var d=JSON.parse(x.responseText);statusEl.textContent='Estado: RELEASES.json cargado desde raíz'; cb(null,d); return}catch(e){statusEl.textContent='ERROR parseando /RELEASES.json: '+e.message} } // fallback to raw github
 statusEl.textContent+='; intentando fallback raw.githubusercontent...'; var raw='https://raw.githubusercontent.com/Karthach/ps3hen/main/RELEASES.json'; ajax(raw,function(err2,x2){ if(!err2){ try{var d2=JSON.parse(x2.responseText); statusEl.textContent='Estado: RELEASES.json cargado desde raw.githubusercontent'; cb(null,d2); return;}catch(e){statusEl.textContent='ERROR parseando raw: '+e.message} } cb(new Error('No se pudo cargar RELEASES.json')) },'text') },'text')}

function buildUI(data){var files=data.files||[];var byVer={};files.forEach(function(f){ if(f.path.indexOf('hen/')===0 && f.path.endsWith('.p3t')){var ver=f.path.match(/hen\/(\d+[\.\d]*D?)\//); var v=ver?ver[1]:'general'; if(!byVer[v]) byVer[v]=[]; byVer[v].push({path:'/'+f.path,sha:f.sha256}); }}); var vers=Object.keys(byVer).sort(function(a,b){return parseFloat(b)-parseFloat(a)}); if(vers.length===0){statusEl.textContent='No se encontraron .p3t en RELEASES.json'; return} sel.innerHTML=''; vers.forEach(function(v){ var o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); sel.addEventListener('change', function(){select(ver=sel.value,byVer)}); select(ver=sel.value,byVer);}

function select(ver,byVer){ var arr=byVer[ver]||[]; if(arr.length===0){downloadBtn.href='#'; fileSha.textContent='SHA256: —'; return} var it=arr[0]; downloadBtn.href=it.path; fileSha.textContent='SHA256: '+(it.sha||'—'); verifyBtn.onclick=function(){verify(it)}; copyBtn.onclick=function(){navigator.clipboard && navigator.clipboard.writeText(location.origin+it.path).then(function(){alert('Enlace copiado')}, function(){prompt('Enlace:',location.origin+it.path)})}}

function verify(it){ ajax(it.path,function(err,x){ if(err){ alert('error download: '+err.message); return } var ab = x.response || x.responseText; if(typeof ab === 'string'){ var bin=''; for(var i=0;i<ab.length;i++){bin+=String.fromCharCode(ab.charCodeAt(i)&0xff)} var buf=new Uint8Array(bin.length); for(i=0;i<bin.length;i++)buf[i]=bin.charCodeAt(i)&0xff; doHash(buf.buffer,it.sha); } else { doHash(ab,it.sha) } },'arraybuffer') }

function toHex(buf){ var a=new Uint8Array(buf),h=''; for(var i=0;i<a.length;i++)h+=('00'+a[i].toString(16)).slice(-2); return h }
function doHash(ab,expected){ if(!window.crypto||!crypto.subtle){alert('Web Crypto no disponible');return} crypto.subtle.digest('SHA-256',ab).then(function(h){ var hh=toHex(h); alert('SHA: '+hh+'\nEsperado: '+expected); }) }

loadReleases(function(err,data){ if(err){statusEl.textContent='Fallo cargando RELEASES.json'; return} buildUI(data) })
</script>
</body>
</html>
